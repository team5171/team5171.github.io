<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resolving Next Event | Team 5171</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Outfit:wght@700&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --bg: #090b0f;
            --glass: rgba(22, 27, 34, .7);
            --border: rgba(255, 255, 255, .08);
            --accent1: #58a6ff;
            --accent2: #bc8cff;
            --text: #e6edf3;
            --dim: #8b949e;
        }

        body {
            margin: 0;
            background: var(--bg);
            font-family: 'Inter', sans-serif;
            color: var(--text);
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        .card {
            width: 420px;
            padding: 40px;
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 24px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        h1 {
            font-family: 'Outfit', sans-serif;
            margin: 0 0 12px 0;
            background: linear-gradient(135deg, var(--accent1), var(--accent2));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            color: var(--dim);
            font-size: .9rem;
        }

        a {
            color: var(--accent1);
            font-weight: 600;
            text-decoration: none;
        }
    </style>
</head>

<body>

    <div class="card">
        <h1 id="title">Resolving Next Event</h1>
        <div class="subtitle" id="subtitle">Fetching calendar...</div>
    </div>

    <script>
        const CALENDAR_ENDPOINT = "https://rsvp.yorkroboticsfrc.workers.dev/calendar";
        const FALLBACK = "https://lu.ma/team5171";

        init();

        async function init() {
            try {
                const res = await fetch(CALENDAR_ENDPOINT);
                if (!res.ok) throw new Error("Calendar fetch failed");

                const text = await res.text();
                const events = parseICS(text);
                const nextEvent = getNextEvent(events);

                if (!nextEvent) throw new Error("No upcoming events");

                const targetUrl = extractUrl(nextEvent.description);
                if (!targetUrl) throw new Error("No link found in event");

                document.getElementById("subtitle").innerText =
                    `Redirecting to: ${nextEvent.summary}`;

                window.location.replace(targetUrl);

            } catch (err) {
                console.error(err);
                document.getElementById("title").innerText = "Redirect Failed";
                document.getElementById("subtitle").innerHTML =
                    `Going to fallback...<br><a href="${FALLBACK}">Click here if not redirected</a>`;
                setTimeout(() => window.location.replace(FALLBACK), 1500);
            }
        }

        /* ---------- ICS PARSER ---------- */

        function parseICS(data) {
            const lines = data.split(/\r\n|\n|\r/);
            const events = [];
            let current = null;

            for (const line of lines) {
                if (line.startsWith("BEGIN:VEVENT")) current = {};
                else if (line.startsWith("END:VEVENT")) {
                    if (current) events.push(current);
                    current = null;
                }
                else if (current) {
                    const [key, ...v] = line.split(":");
                    const value = v.join(":");
                    if (key.includes("DTSTART")) current.start = value;
                    if (key.includes("DTEND")) current.end = value;
                    if (key.includes("SUMMARY")) current.summary = value;
                    if (key.includes("DESCRIPTION")) current.description = value;
                }
            }
            return events;
        }

        function getNextEvent(events) {
            const now = new Date();

            const parseDate = (d) => {
                if (!d) return null;
                if (d.length === 8) return new Date(`${d.substring(0, 4)}-${d.substring(4, 6)}-${d.substring(6, 8)}`);
                const y = d.substring(0, 4), m = d.substring(4, 6), day = d.substring(6, 8),
                    h = d.substring(9, 11), min = d.substring(11, 13), s = d.substring(13, 15);
                return d.endsWith('Z') ? new Date(Date.UTC(y, m - 1, day, h, min, s)) : new Date(y, m - 1, day, h, min, s);
            };

            return events.map(e => {
                const startDate = parseDate(e.start);
                if (!startDate) return null;
                const endDate = parseDate(e.end) || new Date(startDate.getTime() + 4 * 60 * 60 * 1000); // 4h default
                return { ...e, startDate, endDate };
            })
                .filter(e => e && e.endDate > now)
                .sort((a, b) => a.startDate - b.startDate)[0];
        }

        function extractUrl(desc) {
            if (!desc) return null;
            const match = desc.match(/https?:\/\/[^\s\\]+/);
            return match ? match[0] : null;
        }
    </script>

</body>

</html>